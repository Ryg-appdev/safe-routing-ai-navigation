# 通常モード・防犯仕様 (Phase 4)

## 概要
ユーザーの「日常の安心」を守るため、物理的な自然災害（洪水・土砂災害など）だけでなく、**人為的なリスク（治安・雰囲気）** を回避するルートを提供する。

## データソース

### 1. Street View Vibe Check (Analyst Agent) - **メイン**
`AnalystAgent` が Google Street View 画像を Gemini Vision API で解析し、以下の視覚的特徴をスコア化する。

**割れ窓理論（Broken Windows Theory）に基づく評価:**
- **落書き (Graffiti)**: 治安悪化の予兆 (-10点)
- **ゴミの散乱**: 管理不行き届き (-10点)
- **照明の少なさ (Darkness)**: 夜間の危険性 (-20点)
- **人通りの少なさ**: 孤立した場所 (-10点)
- **監視カメラ**: 防犯意識の高さ (+5点)

> [!NOTE]
> この方式は **Street View が存在する場所であれば世界中どこでも機能** します。
> 統計データに依存しないため、日本国内に限らず海外でも同様の精度で動作します。

### 2. Safety Facilities (Places API)
Google Places API を使用し、ルート上の安全施設をチェックする。

| 施設タイプ | 効果 | 理由 |
|---|---|---|
| 交番 (Police) | +10点 | 犯罪抑止効果が高い |
| コンビニ (24h) | +5点 | 明るさ・人の目がある |
| 病院・クリニック | +5点 | 緊急時の駆け込み先 |

### 3. 犯罪統計データ (Crime Statistics) - **将来対応**
現在は未実装。将来的に全国統一のオープンデータが整備された場合に対応予定。

> [!IMPORTANT]
> **Mock（偽）データは使用しません。**
> 以前のバージョンでは歌舞伎町等のハードコードされたエリアがありましたが、
> 「嘘のデータを表示しない」方針に基づき削除しました。

## リスク評価アルゴリズム
ルート上の各ポイント（100m間隔）に対して以下の計算を行う。

**Base Score: 100点**

1.  **Vibe Check (Vision API)**:
    - Analyst Agent による画像解析スコアを減算
    - 最大 -50点（非常に危険な見た目の場合）

2.  **Safety Bonus (Places API)**:
    - 交番、コンビニ（24h）、病院が半径100m以内にある場合: +5〜10点

3.  **Bottleneck Logic**:
    - ルート全体のスコアは「最も低いポイントのスコア」で決定
    - 99% 安全でも 1% 危険なら、そのルートは「危険」と判定

## UI仕様

### 1. マーカー表示（通常モード）
- **安全 (Score >= 70)**: シアン色の丸マーカー（スキャン済み）
- **注意 (50 <= Score < 70)**: 黄色の「！」アイコン
- **危険 (Score < 50)**: 赤色の警告アイコン

### 2. ナレーション例
- 「このルートは **人通りが多く明るい道** を優先しています。」
- 「一部のエリアで **照明が少ない箇所** があります。注意して通行してください。」

## 技術実装
- **Backend**: `analyst.py` (Vision AI), `places_service.py` (Safety Facilities)
- **Frontend**: `map_screen.dart` で分析ポイントをマーカー表示
