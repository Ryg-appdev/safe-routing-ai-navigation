# 03_システムアーキテクチャ.md

## 1. 全体構成図 (Architecture Visualization)

本システムのアーキテクチャは、**Client-Server-Agent** の3層構造です。
クライアント（iOS）はUIとセンシングに専念し、複雑な意思決定は Backend 上の **Agentic AI** が担います。

```mermaid
flowchart TB
    subgraph Client [📱 Mobile Client]
        iOS[iOS App (SwiftUI)]
        MapsSDK[Google Maps SDK]
        GPS[Location Manager]
        iOS --> MapsSDK
        iOS --> GPS
    end

    subgraph Backend [☁️ Google Cloud / Firebase]
        Genkit[Firebase Genkit (Node.js)]
        Functions[Cloud Functions]
        Firestore[(Firestore: Logs)]
        
        iOS -- "POST /findSafeRoute" --> Functions
        Functions --> Genkit
        Genkit -- "Log History" --> Firestore
    end

    subgraph Agents [🤖 Agentic Workflow]
        InputAgent[Input Agent<br/>(Context Gathering)]
        RiskAgent[Risk Evaluator<br/>(Gemini 3 Reasoning)]
        RouteAgent[Route Selector<br/>(Autonomous Retry)]
        VisionAgent[Visual Analyst<br/>(Gemini Pro Vision)]
        Narrator[Narrator Agent<br/>(Explanation)]

        Genkit --> InputAgent
        InputAgent --> RiskAgent
        RiskAgent --> RouteAgent
        RouteAgent -- "If risky" --> RouteAgent
        RouteAgent --> Narrator
        
        %% Vision Analysis Flow
        Genkit -.-> VisionAgent
    end

    subgraph APIs [🌍 External Data Sources]
        direction LR
        WeatherAPI[OpenWeatherMap API<br/>(Rain/Wind)]
        HazardAPI[国土交通省ハザードマップ<br/>(Tile Data)]
        PoliceData[警視庁統計データ<br/>(CSV/Static)]
        RoutesAPI[Google Routes API]
        StreetView[Street View Static API]

        InputAgent <--> WeatherAPI
        InputAgent <--> HazardAPI
        InputAgent <--> PoliceData
        RouteAgent <--> RoutesAPI
        VisionAgent <--> StreetView
    end
```

## 2. コンポーネント詳細

### ✅ Frontend (iOS App)
ユーザーインターフェースを提供します。
- **Google Maps SDK**: 地図描画・ポリライン表示を担当。
- **MVVM**: UIロジックと描画を分離し、テスト容易性を確保。
- **Server-Sent Events (SSE)**: AIの「思考ログ」をリアルタイムに受信・表示します。

### ✅ Backend (Firebase Genkit)
アプリケーションの脳みそとなる部分です。Google 推奨の **Agentic AI フレームワーク** を採用しています。
- **Input Agent**: 複数の外部APIから「現在の状況（天気、災害リスク、治安）」を収集し、統合します。
- **Risk Evaluator (Gemini 3)**: 最新の **Gemini 3** モデルを使用し、収集したデータから「今の状況でこの道を通るべきか？」を人間のように推論します。
- **Route Selector**: Google Routes API を操作し、リスク評価に基づいた最適なルートを選定します。「全ルート危険」と判断した場合は、自律的に経由地を生成して再検索（Retry）を行います。

### ✅ External APIs (外部連携)
一般利用可能なAPIおよびオープンデータを採用しています。
- **Google Routes API**: 高度な経路探索（代替ルート取得）に使用。
- **OpenWeatherMap**: 商用利用可能な気象API。リアルタイムの雨量・風速を取得。
- **Google Street View Static API**: 地点の画像を動的に取得し、AIの視覚解析（明るさ・雰囲気スコア）に使用。
- **国土交通省 / 警視庁オープンデータ**: ハザード情報や犯罪統計は、APIまたは事前に加工した統計データとして利用します。
