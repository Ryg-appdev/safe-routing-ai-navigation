# 04_基本設計書.md

## 1. データモデル (Data Models)

### データフロー概要図

```mermaid
flowchart LR
    subgraph Client ["📱 iOS App"]
        UI["SwiftUI View"]
        VM["ViewModel"]
        API["API Client"]
    end

    subgraph Request ["リクエスト"]
        RQ["RouteRequest"]
    end

    subgraph Response ["レスポンス"]
        RS["RouteResponse"]
        SR["SafeRoute"]
        TL["ThinkingLog"]
    end

    subgraph Server ["☁️ Cloud Run"]
        ADK["Google ADK"]
    end

    UI --> VM --> API
    API -->|POST /findSafeRoute| RQ
    RQ --> ADK
    ADK --> RS
    RS --> SR
    RS --> TL
    SR --> API
    TL --> API
    API --> VM --> UI
```

### RouteRequest (Client -> Server)
```python
@dataclass
class RouteRequest:
    origin: LatLng        # 出発地
    destination: LatLng   # 目的地
    mode: Literal["NORMAL", "EMERGENCY"]  # ユーザーモード
    alert_type: Optional[str] = None  # 気象警報種別（自動切替時）
```

### RouteResponse (Server -> Client)
```python
@dataclass
class RouteResponse:
    routes: List[SafeRoute]       # 提案ルート（複数）
    generated_waypoints: Optional[List[LatLng]]  # AIが生成した経由地
    narrative: str                # AIからの説明
    thinking_process_log: List[str]  # 思考ログ
    risk_assessment: RiskAssessment

@dataclass
class SafeRoute:
    polyline: str         # Encoded Polyline
    summary: str
    duration_seconds: int
    safety_score: int     # 0-100
    warnings: List[str]   # 特定のリスク警告

@dataclass
class RiskAssessment:
    level: Literal["LOW", "MEDIUM", "HIGH"]
    factors: List[str]    # "Flood Risk", "Tsunami Warning"
```

## 2. モード別処理フロー概要

### A. 通常モード (Normal)

```mermaid
flowchart TD
    A["リクエスト受信"] --> B["コンテキスト取得"]
    B --> C["治安統計取得"]
    B --> D["時間帯判定"]
    C --> E{"夜間?"}
    D --> E
    E -->|Yes| F["Street View解析"]
    E -->|No| G["治安スコア計算"]
    F --> H["安全ルート選択"]
    G --> H
    H --> I["ナレーション生成"]
    I --> J["レスポンス返却"]
```

**処理ステップ:**
1. **Request**: 目的地を設定。
2. **Context**: 治安統計・時間帯を確認。
3. **Logic**:
   - **日中**: 治安スコアを重視した安全ルートを選択。
   - **夜間**: 治安スコア + Street View解析（明るさ）を考慮。
4. **Response**: 「少し遠回りですが、明るい大通りを選びました」と提案。

### B. 非常時モード (Emergency)

```mermaid
flowchart TD
    A["リクエスト受信"] --> B{"警報種別?"}
    B -->|大雨/洪水| C["浸水ハザードマップ照合"]
    B -->|土砂災害| D["土砂ハザードマップ照合"]
    B -->|津波| E["津波ハザードマップ照合"]
    
    C --> F["危険エリア特定"]
    D --> F
    E --> F
    
    F --> G["回避ルート検索"]
    G --> H{"安全ルートあり?"}
    H -->|Yes| I["最安全ルート選択"]
    H -->|No| J["🔄 自律リトライ"]
    J --> K["安全地点をWaypoint設定"]
    K --> G
    I --> L["緊急ナレーション生成"]
    L --> M["レスポンス返却"]
```

**処理ステップ:**
1. **Request**: ユーザーが非常時スイッチON、または気象警報で自動切替。
2. **Context**: 警報の種類に応じて該当するハザードマップのみを照合。
3. **Logic**:
   - 危険エリアを特定し、回避ルートを検索。
   - 全ルート危険なら「自律リトライ（回避地点生成）」を実行。
4. **Response**: 「津波警報が発令されています。高台経由のルートに変更しました」と提案。
