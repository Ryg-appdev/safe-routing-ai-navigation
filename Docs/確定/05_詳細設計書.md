# 05_è©³ç´°è¨­è¨ˆæ›¸.md

## 1. Agentic Workflow å…¨ä½“å›³

```mermaid
flowchart TB
    subgraph Client ["ğŸ“± Flutter App"]
        REQ["POST /findSafeRoute"]
    end

    subgraph Backend ["â˜ï¸ Cloud Run"]
        ADK["Google ADK"]
    end

    subgraph Agents ["ğŸ¤– Agentic Workflow"]
        direction TB
        A1["1ï¸âƒ£ Input Agent<br/>æƒ…å ±åé›†"]
        A2["2ï¸âƒ£ Risk Evaluator<br/>Vertex AI æ¨è«–"]
        A3["3ï¸âƒ£ Route Selector<br/>çµŒè·¯æ¢ç´¢"]
        A4["4ï¸âƒ£ Narrator<br/>èª¬æ˜ç”Ÿæˆ"]
        
        A1 --> A2
        A2 --> A3
        A3 -->|å…¨ãƒ«ãƒ¼ãƒˆå±é™º| A3
        A3 --> A4
    end

    subgraph APIs ["ğŸŒ External APIs"]
        W["OpenWeatherMap"]
        H["ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—"]
        P["è­¦è¦–åºçµ±è¨ˆ"]
        R["Google Routes"]
        S["Street View"]
    end

    REQ --> ADK --> A1
    A1 <--> W
    A1 <--> H
    A1 <--> P
    A3 <--> R
    A2 -.-> S
    A4 --> ADK --> REQ
```

## 2. Agentåˆ¥è©³ç´°è¨­è¨ˆ

## 2. Agentåˆ¥è©³ç´°è¨­è¨ˆ (True Agentic Architecture)

### ğŸ•µï¸ The Sentinel (å¸ä»¤å¡” / Dispatcher)
ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ¢ã€‚Gemini 3 Pro ã®æ¨è«–èƒ½åŠ›(CoT)ã‚’æ´»ã‹ã—ã€çŠ¶æ³åˆ¤æ–­ã¨ã‚¿ã‚¹ã‚¯ã®æŒ¯ã‚Šåˆ†ã‘ã‚’è¡Œã†ã€‚
- **æ©Ÿèƒ½**:
    1.  **Observation**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚„Navigatorã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦³å¯Ÿã€‚
    2.  **Reasoning**: ã€Œä»Šã¯å®‰å…¨ã‹ï¼Ÿã€ã€Œè¦–è¦šæƒ…å ±ãŒå¿…è¦ã‹ï¼Ÿã€ã‚’æ¨è«–ã€‚
    3.  **Routing**: Navigatorã‚„Analystã«æŒ‡ç¤ºã‚’å‡ºã™ã€‚

### ğŸ—ºï¸ The Navigator (æ¢ç´¢ / Tool User)
å®Ÿå‹™æ‹…å½“ã€‚å¤–éƒ¨APIã‚’é§†ä½¿ã—ã¦æƒ…å ±ã‚’é›†ã‚ã€ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ã™ã‚‹ã€‚
- **ãƒ¢ãƒ‡ãƒ«**: Gemini 3 Flash (é«˜é€Ÿæ€§é‡è¦–)
- **Tools**:
    - `find_routes`: Routes APIã§çµŒè·¯æ¢ç´¢ã€‚
    - `check_risks`: OpenWeatherMap, ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—, Solar API, Places API, çŠ¯ç½ªçµ±è¨ˆã‚’ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯ã€‚

### ğŸ‘ï¸ The Analyst (è¦–è¦š / Vision)
è¦–è¦šæ‹…å½“ã€‚å¿…è¦ãªå ´åˆã®ã¿Sentinelã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
- **ãƒ¢ãƒ‡ãƒ«**: Gemini 3 Flash (Multimodal)
- **Tools**:
    - `analyze_street_view`: åº§æ¨™ã‹ã‚‰ç”»åƒã‚’å¼•ã„ã¦ãƒªã‚¹ã‚¯è©•ä¾¡ã€‚

### ğŸ›¡ï¸ The Guardian (å®ˆè­·è€… / Narrator)
ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾è©±æ‹…å½“ã€‚Sentinelã®æ±ºå®šã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼ãˆã‚‹ã€‚
- **ãƒ¢ãƒ‡ãƒ«**: Gemini 3 Pro (å¯¾è©±å“è³ªé‡è¦–)
- **æ©Ÿèƒ½**:
    - **Normal Mode**: ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã®ã‚ˆã†ãªä¸å¯§ãªæ¡ˆå†…ã€‚
    - **Emergency Mode**: çŸ­ãçš„ç¢ºãªæŒ‡ç¤ºã¨ã€å®‰å¿ƒã•ã›ã‚‹è¨€è‘‰ãŒã‘ã€‚

## 3. ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯è©³èª¬ï¼ˆãƒãƒªãƒ©ã‚¤ãƒ³åˆ†è§£ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®‰å…¨ã‚’ãã‚ç´°ã‹ãè©•ä¾¡ã™ã‚‹ãŸã‚ã€ãƒ«ãƒ¼ãƒˆå…¨ä½“ã‚’ã²ã¨ã¾ã¨ã‚ã«ã™ã‚‹ã®ã§ã¯ãªãã€åˆ†è§£ã—ã¦è©•ä¾¡ã—ã¾ã™ã€‚

### 3.1 ãƒãƒªãƒ©ã‚¤ãƒ³åˆ†è§£ã¨ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æˆ¦ç•¥ (Route Sampling)
ã‚°ãƒªãƒƒãƒ‰æ–¹å¼ã§ã¯ãªãã€**Route Samplingæ–¹å¼**ï¼ˆãƒ«ãƒ¼ãƒˆã«æ²¿ã£ã¦ç‚¹ã‚’è©•ä¾¡ã™ã‚‹ï¼‰ã‚’æ¡ç”¨ã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿéš›ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€šã‚‹é“ã®å®‰å…¨æ€§ã ã‘ã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§è©•ä¾¡ã§ãã€APIã‚³ã‚¹ãƒˆã‚‚æœ€é©åŒ–ã•ã‚Œã¾ã™ã€‚

1.  **ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†è§£**: Google Routes APIã‹ã‚‰å¾—ã‚‰ã‚ŒãŸPolylineã‚’ **50mé–“éš”** ã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
    - æ—¥æœ¬ã®è¡—ç¯é–“éš”ï¼ˆç´„30-50mï¼‰ã‚’è€ƒæ…®ã—ã€æš—ã„åŒºé–“ã‚’è¦‹é€ƒã•ãªã„ãŸã‚ã®è¨­å®šã§ã™ã€‚
2.  **é‡è¦ãƒã‚¤ãƒ³ãƒˆ**: ã€Œäº¤å·®ç‚¹ï¼ˆTurnï¼‰ã€ã‚„ã€Œä¿¡å·å¾…ã¡ãŒç™ºç”Ÿã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã€ã¯50mé–“éš”ã«ã‹ã‹ã‚ã‚‰ãšå¿…ãšè©•ä¾¡ç‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚

### 3.2 ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«è©•ä¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (å„ãƒã‚¤ãƒ³ãƒˆã”ã¨)

å„ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ $P_i$ ã«å¯¾ã—ã€ä»¥ä¸‹ã®ã‚¹ã‚³ã‚¢ $S_i$ ã‚’ç®—å‡ºã—ã¾ã™ã€‚

$$ S_i = w_1 \cdot C(P_i) + w_2 \cdot E(P_i) + w_3 \cdot V(P_i) $$

- **$C(P_i)$ çŠ¯ç½ªãƒªã‚¹ã‚¯ (Crime)**:
  - è­¦è¦–åºã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆFirestore + Geohashï¼‰ã‹ã‚‰å‘¨è¾ºã®çŠ¯ç½ªç™ºç”Ÿç‡ã‚’å–å¾—ã€‚
- **$E(P_i)$ ç’°å¢ƒãƒªã‚¹ã‚¯ (Environment)**:
  - **Solar API**: `sunshine_hours` ãŒä½ã„ = å»ºç‰©ç­‰ã®å½±ãŒå¤šã„ = **ã€Œå¤œé“ãŒæš—ã„ã€** ã¨åˆ¤å®š (+Risk)ã€‚
  - **Places API**: åŠå¾„100mä»¥å†…ã«ã€Œé€ƒã’è¾¼ã‚ã‚‹å ´æ‰€ (ã‚³ãƒ³ãƒ“ãƒ‹, äº¤ç•ª, é§…)ã€ãŒã‚ã‚‹ã‹åˆ¤å®š (-Risk)ã€‚
  - **OpenWeatherMap**: æµ¸æ°´ã‚¨ãƒªã‚¢ã«å«ã¾ã‚Œã‚‹ã‹åˆ¤å®š (+Risk)ã€‚
- **$V(P_i)$ è¦–è¦šãƒªã‚¹ã‚¯ (Vision)**:
  - *éåŒæœŸå®Ÿè¡Œ*: Street Viewç”»åƒã‚’Gemini Visionã§è§£æã€‚ã€Œè¡—ç¯ãŒãªã„ã€ã€Œè½æ›¸ããŒå¤šã„ã€ãªã©ã‚’æ¤œçŸ¥ã€‚

### 3.3 ç·åˆã‚¹ã‚³ã‚¢ç®—å‡º (Bottleneck Evaluation)
ãƒ«ãƒ¼ãƒˆå…¨ä½“ã®æ¨å¥¨åº¦ã¯ã€å¹³å‡ç‚¹ã§ã¯ãªã **ã€Œãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼ˆæœ€ä½ç‚¹ï¼‰ã€** ã§æ±ºã¾ã‚Šã¾ã™ã€‚
ã€Œ99%å®‰å…¨ã§ã‚‚ã€1ã‹æ‰€ã ã‘æ¥µã‚ã¦å±é™ºãªè·¯åœ°ãŒã‚ã‚‹ãªã‚‰ã€ãã®ãƒ«ãƒ¼ãƒˆã¯æ¨å¥¨ã—ãªã„ã€ã¨ã„ã†è¨­è¨ˆæ€æƒ³ã§ã™ã€‚

> è©³ã—ãã¯ [ãƒ­ã‚¸ãƒƒã‚¯å›³å‚ç…§](Docs/ç¢ºå®š/diagrams/15_ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯.md)

## 4. éåŒæœŸå®‰å…¨æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Async Visual Analysis)

```mermaid
sequenceDiagram
    participant App as Flutter App
    participant CR as Cloud Run
    participant SV as Street View API
    participant G3 as Vertex AI Vision

    App->>CR: POST /analyzeRouteSafety (points[])
    loop å„åœ°ç‚¹ã‚’é †æ¬¡å‡¦ç†
        CR->>SV: ç”»åƒå–å¾— (lat, lng)
        SV-->>CR: Street View ç”»åƒ
        CR->>G3: å®‰å…¨æ€§è§£æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        G3-->>CR: Score + Comment
        CR-->>App: SSE: {id, score, comment}
    end
    App->>App: åœ°å›³ä¸Šã«ãƒ”ãƒ³è¡¨ç¤º
```

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

| API | å¤±æ•—æ™‚ã®æŒ™å‹• |
| :--- | :--- |
| **OpenWeatherMap** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’ã€Œä¸­ã€ã§ç¶™ç¶šã€‚ |
| **Google Routes API** | äº‹å‰ã«å®šç¾©ã—ãŸãƒ¢ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆï¼ˆæ¸‹è°·ã‚¨ãƒªã‚¢ç”¨ï¼‰ã‚’è¿”å´ã€‚ |
| **Street View Static API** | è©²å½“åœ°ç‚¹ã®ã‚¹ã‚³ã‚¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ¬¡ã®åœ°ç‚¹ã¸é€²ã‚€ã€‚ |
| **Vertex AI (Gemini)** | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯å›ºå®šã®æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã€‚ |
