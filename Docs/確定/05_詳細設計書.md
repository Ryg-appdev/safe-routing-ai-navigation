# 05_è©³ç´°è¨­è¨ˆæ›¸.md

## 1. Agentic Workflow å…¨ä½“å›³

```mermaid
flowchart TB
    subgraph Client [ğŸ“± iOS App]
        REQ[POST /findSafeRoute]
    end

    subgraph Backend [â˜ï¸ Cloud Functions]
        GK[Genkit Flow]
    end

    subgraph Agents [ğŸ¤– Agentic Workflow]
        direction TB
        A1[1ï¸âƒ£ Input Agent<br/>æƒ…å ±åé›†]
        A2[2ï¸âƒ£ Risk Evaluator<br/>Gemini 3 æ¨è«–]
        A3[3ï¸âƒ£ Route Selector<br/>çµŒè·¯æ¢ç´¢]
        A4[4ï¸âƒ£ Narrator<br/>èª¬æ˜ç”Ÿæˆ]
        
        A1 --> A2
        A2 --> A3
        A3 -->|å…¨ãƒ«ãƒ¼ãƒˆå±é™º| A3
        A3 --> A4
    end

    subgraph APIs [ğŸŒ External APIs]
        W[OpenWeatherMap]
        H[ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—]
        P[è­¦è¦–åºçµ±è¨ˆ]
        R[Google Routes]
        S[Street View]
    end

    REQ --> GK --> A1
    A1 <--> W
    A1 <--> H
    A1 <--> P
    A3 <--> R
    A2 -.-> S
    A4 --> GK --> REQ
```

## 2. Agentåˆ¥è©³ç´°è¨­è¨ˆ

### Agent 1: Input Agent (æƒ…å ±åé›†)

```mermaid
flowchart LR
    subgraph ä¸¦åˆ—å–å¾—
        W[OpenWeatherMap] --> |rain, wind| CTX
        H[ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—] --> |flood_depth| CTX
        P[è­¦è¦–åºçµ±è¨ˆ] --> |crime_rate| CTX
        M[Mockäº‹æ•…ãƒ‡ãƒ¼ã‚¿] --> |accidents| CTX
    end
    CTX[Context Object] --> A2[Risk Evaluator]
```

- ä¸¦åˆ—å®Ÿè¡Œ (`Promise.all`) ã§ä»¥ä¸‹ã‚’å–å¾—ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
  - `weather`: { rain: 55mm/h, wind: 15m/s }
  - `hazard`: { floodDepth: 0.5m, landslideRisk: low }
  - `traffic`: { accidents: [ConfiguredMockData] }

### Agent 2: Risk Evaluator (ãƒªã‚¹ã‚¯è©•ä¾¡)

```mermaid
flowchart TD
    CTX[Context + Mode] --> G3[Gemini 3]
    G3 --> |JSON Output| RS{Risk Score}
    RS -->|0-30| LOW[LOW ãƒªã‚¹ã‚¯]
    RS -->|31-70| MED[MEDIUM ãƒªã‚¹ã‚¯]
    RS -->|71-100| HIGH[HIGH ãƒªã‚¹ã‚¯]
    
    LOW --> TAGS[Avoidance Tags ç”Ÿæˆ]
    MED --> TAGS
    HIGH --> TAGS
    TAGS --> A3[Route Selector ã¸]
```

- **å…¥åŠ›**: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ + ãƒ¢ãƒ¼ãƒ‰
- **å‡¦ç†**: **Gemini 3** ã‚’ä½¿ç”¨ã—ã€JSONå½¢å¼ã§ãƒªã‚¹ã‚¯ä¿‚æ•°ã‚’ç®—å‡ºã€‚
- **Output Schema**:
  ```json
  {
    "baseRiskScore": 85,
    "avoidanceTags": ["LOW_ELEVATION", "RIVER_SIDE"],
    "priority": "SURVIVAL"
  }
  ```

### Agent 3: Route Selector (çµŒè·¯æ¢ç´¢ & è‡ªå¾‹ãƒªãƒˆãƒ©ã‚¤)

```mermaid
flowchart TD
    A[Routes API ã‚³ãƒ¼ãƒ«] --> B[ä»£æ›¿ãƒ«ãƒ¼ãƒˆ3-5æœ¬å–å¾—]
    B --> C{å„ãƒ«ãƒ¼ãƒˆã‚’<br/>ãƒã‚¶ãƒ¼ãƒ‰ã¨äº¤å·®åˆ¤å®š}
    C --> D{å®‰å…¨ãƒ«ãƒ¼ãƒˆ<br/>ã‚ã‚Š?}
    D -->|Yes| E[æœ€å®‰å…¨ãƒ«ãƒ¼ãƒˆé¸æŠ]
    D -->|No| F[ğŸ”„ Agentic Loop]
    
    subgraph F [è‡ªå¾‹ãƒªãƒˆãƒ©ã‚¤]
        F1[å®‰å…¨ã‚¨ãƒªã‚¢ã®é‡å¿ƒè¨ˆç®—]
        F2[Waypoint ã¨ã—ã¦è¨­å®š]
        F3[å†åº¦ Routes API ã‚³ãƒ¼ãƒ«]
        F1 --> F2 --> F3
    end
    
    F3 --> C
    E --> G[Agent 4 ã¸]
```

- **Step 1**: Google Routes API (computeRoutes) ã‚’ã‚³ãƒ¼ãƒ«ã€‚
  - `computeAlternativeRoutes: true`
  - `routingPreference: TRAFFIC_AWARE`
- **Step 2**: å–å¾—ã—ãŸ Polyline ã¨ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆGeoJSONï¼‰ã‚’äº¤å·®åˆ¤å®šã€‚
- **Step 3 (The Agentic Loop)**: å…¨ãƒ«ãƒ¼ãƒˆå±é™ºæ™‚ã¯è‡ªå¾‹çš„ã«Waypointã‚’ç”Ÿæˆã—ã¦ãƒªãƒˆãƒ©ã‚¤ã€‚

### Agent 4: Narrator (ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼)

```mermaid
flowchart LR
    subgraph Input
        R[æœ€çµ‚ãƒ«ãƒ¼ãƒˆ]
        RA[ãƒªã‚¹ã‚¯è©•ä¾¡]
        M[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰]
    end
    
    Input --> P{Personaé¸æŠ}
    P -->|Normal| C[Concierge<br/>ä¸å¯§ãƒ»å®‰å¿ƒ]
    P -->|Emergency| T[Tactical<br/>å‘½ä»¤å½¢ãƒ»çŸ­æ½”]
    
    C --> G3[Gemini 3]
    T --> G3
    G3 --> N[ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ]
```

- **å…¥åŠ›**: æœ€çµ‚æ±ºå®šãƒ«ãƒ¼ãƒˆ + ãƒªã‚¹ã‚¯è©•ä¾¡ + ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰
- **å‡¦ç†**: **Gemini 3** ã‚’ä½¿ç”¨ã—ã€Personaã«åŸºã¥ã„ã¦ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã€‚

## 3. éåŒæœŸå®‰å…¨æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Async Visual Analysis)

```mermaid
sequenceDiagram
    participant iOS as iOS App
    participant CF as Cloud Functions
    participant SV as Street View API
    participant G3 as Gemini 3 Vision

    iOS->>CF: POST /analyzeRouteSafety (points[])
    loop å„åœ°ç‚¹ã‚’é †æ¬¡å‡¦ç†
        CF->>SV: ç”»åƒå–å¾— (lat, lng)
        SV-->>CF: Street View ç”»åƒ
        CF->>G3: å®‰å…¨æ€§è§£æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        G3-->>CF: Score + Comment
        CF-->>iOS: SSE: {id, score, comment}
    end
    iOS->>iOS: åœ°å›³ä¸Šã«ãƒ”ãƒ³è¡¨ç¤º
```

- ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã¯åˆ‡ã‚Šé›¢ã—ã€åˆ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/analyzeRouteSafety` ã¾ãŸã¯SSEã‚¹ãƒˆãƒªãƒ¼ãƒ ã§æä¾›ã€‚
- **Input**: ãƒ«ãƒ¼ãƒˆä¸Šã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°åº§æ¨™ï¼ˆ500mã”ã¨ or äº¤å·®ç‚¹ï¼‰ã€‚
- **Output**: `{ lat, lng, score, comment }` ã‚’é †æ¬¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ã€‚

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### APIå¤±æ•—æ™‚ã®æŒ™å‹•

```mermaid
flowchart TD
    A[API Call] --> B{æˆåŠŸ?}
    B -->|Yes| C[æ­£å¸¸å‡¦ç†ç¶šè¡Œ]
    B -->|No| D{ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š?}
    D -->|Yes| E[ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨]
    D -->|No| F[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨]
    E --> G[Thinking Logã«è­¦å‘Šè¿½åŠ ]
    F --> G
    G --> C
```

| API | å¤±æ•—æ™‚ã®æŒ™å‹• |
| :--- | :--- |
| **OpenWeatherMap** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ã€Œå¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€ã¨ã—ã¦ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’ã€Œä¸­ã€ã§ç¶™ç¶šã€‚ |
| **Google Routes API** | äº‹å‰ã«å®šç¾©ã—ãŸãƒ¢ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆï¼ˆæ¸‹è°·ã‚¨ãƒªã‚¢ç”¨ï¼‰ã‚’è¿”å´ã—ã€ãƒ‡ãƒ¢ã‚’ç¶™ç¶šã€‚ |
| **Street View Static API** | è©²å½“åœ°ç‚¹ã®ã‚¹ã‚³ã‚¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ¬¡ã®åœ°ç‚¹ã¸é€²ã‚€ã€‚ |
| **Gemini 3** | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯å›ºå®šã®æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã€‚ |
