# 05_è©³ç´°è¨­è¨ˆæ›¸.md

## 1. Agentic Workflow å…¨ä½“å›³

```mermaid
flowchart TB
    subgraph Client ["ğŸ“± Flutter App"]
        REQ["POST /findSafeRoute"]
    end

    subgraph Backend ["â˜ï¸ Cloud Run"]
        ADK["Google ADK"]
    end

    subgraph Agents ["ğŸ¤– Agentic Workflow"]
        direction TB
        A1["1ï¸âƒ£ Input Agent<br/>æƒ…å ±åé›†"]
        A2["2ï¸âƒ£ Risk Evaluator<br/>Vertex AI æ¨è«–"]
        A3["3ï¸âƒ£ Route Selector<br/>çµŒè·¯æ¢ç´¢"]
        A4["4ï¸âƒ£ Narrator<br/>èª¬æ˜ç”Ÿæˆ"]
        
        A1 --> A2
        A2 --> A3
        A3 -->|å…¨ãƒ«ãƒ¼ãƒˆå±é™º| A3
        A3 --> A4
    end

    subgraph APIs ["ğŸŒ External APIs"]
        W["OpenWeatherMap"]
        H["ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—"]
        P["è­¦è¦–åºçµ±è¨ˆ"]
        R["Google Routes"]
        S["Street View"]
    end

    REQ --> ADK --> A1
    A1 <--> W
    A1 <--> H
    A1 <--> P
    A3 <--> R
    A2 -.-> S
    A4 --> ADK --> REQ
```

## 2. Agentåˆ¥è©³ç´°è¨­è¨ˆ

### Agent 1: Input Agent (æƒ…å ±åé›†)

```mermaid
flowchart LR
    subgraph ä¸¦åˆ—å–å¾—
        W["OpenWeatherMap"] --> |rain, alerts| CTX
        H["ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—"] --> |flood, landslide, tsunami| CTX
        P["è­¦è¦–åºçµ±è¨ˆ"] --> |crime_rate| CTX
    end
    CTX["Context Object"] --> A2["Risk Evaluator"]
```

- ä¸¦åˆ—å®Ÿè¡Œ (`asyncio.gather`) ã§ä»¥ä¸‹ã‚’å–å¾—ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
  - `weather`: { rain: 55mm/h, alerts: ["å¤§é›¨è­¦å ±"] }
  - `hazard`: { flood_depth: 0.5m, landslide_risk: "low", tsunami_risk: "none" }
  - `crime`: { area_score: 72 }

### Agent 2: Risk Evaluator (ãƒªã‚¹ã‚¯è©•ä¾¡)

```mermaid
flowchart TD
    CTX["Context + Mode + AlertType"] --> G3["Vertex AI Gemini"]
    G3 --> |JSON Output| RS{"Risk Score"}
    RS -->|0-30| LOW["LOW ãƒªã‚¹ã‚¯"]
    RS -->|31-70| MED["MEDIUM ãƒªã‚¹ã‚¯"]
    RS -->|71-100| HIGH["HIGH ãƒªã‚¹ã‚¯"]
    
    LOW --> TAGS["Avoidance Tags ç”Ÿæˆ"]
    MED --> TAGS
    HIGH --> TAGS
    TAGS --> A3["Route Selector ã¸"]
```

- **å…¥åŠ›**: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ + ãƒ¢ãƒ¼ãƒ‰ + è­¦å ±ç¨®åˆ¥
- **å‡¦ç†**: **Vertex AI (Gemini)** ã‚’ä½¿ç”¨ã—ã€JSONå½¢å¼ã§ãƒªã‚¹ã‚¯ä¿‚æ•°ã‚’ç®—å‡ºã€‚
- **Output Schema**:
  ```json
  {
    "baseRiskScore": 85,
    "avoidanceTags": ["LOW_ELEVATION", "COASTAL_AREA"],
    "priority": "SURVIVAL",
    "selectedHazard": "TSUNAMI"
  }
  ```

### Agent 3: Route Selector (çµŒè·¯æ¢ç´¢ & è‡ªå¾‹ãƒªãƒˆãƒ©ã‚¤)

```mermaid
flowchart TD
    A["Routes API ã‚³ãƒ¼ãƒ«"] --> B["ä»£æ›¿ãƒ«ãƒ¼ãƒˆ3-5æœ¬å–å¾—"]
    B --> C{"å„ãƒ«ãƒ¼ãƒˆã‚’<br/>ãƒã‚¶ãƒ¼ãƒ‰ã¨äº¤å·®åˆ¤å®š"}
    C --> D{"å®‰å…¨ãƒ«ãƒ¼ãƒˆ<br/>ã‚ã‚Š?"}
    D -->|Yes| E["æœ€å®‰å…¨ãƒ«ãƒ¼ãƒˆé¸æŠ"]
    D -->|No| F["ğŸ”„ Agentic Loop"]
    
    subgraph F ["è‡ªå¾‹ãƒªãƒˆãƒ©ã‚¤"]
        F1["å®‰å…¨ã‚¨ãƒªã‚¢ã®é‡å¿ƒè¨ˆç®—"]
        F2["Waypoint ã¨ã—ã¦è¨­å®š"]
        F3["å†åº¦ Routes API ã‚³ãƒ¼ãƒ«"]
        F1 --> F2 --> F3
    end
    
    F3 --> C
    E --> G["Agent 4 ã¸"]
```

- **Step 1**: Google Routes API (computeRoutes) ã‚’ã‚³ãƒ¼ãƒ«ã€‚
- **Step 2**: å–å¾—ã—ãŸ Polyline ã¨è©²å½“ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆGeoJSONï¼‰ã‚’äº¤å·®åˆ¤å®šã€‚
- **Step 3 (The Agentic Loop)**: å…¨ãƒ«ãƒ¼ãƒˆå±é™ºæ™‚ã¯è‡ªå¾‹çš„ã«Waypointã‚’ç”Ÿæˆã—ã¦ãƒªãƒˆãƒ©ã‚¤ã€‚

### Agent 4: Narrator (ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼)

```mermaid
flowchart LR
    subgraph Input
        R["æœ€çµ‚ãƒ«ãƒ¼ãƒˆ"]
        RA["ãƒªã‚¹ã‚¯è©•ä¾¡"]
        M["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰"]
    end
    
    Input --> P{"Personaé¸æŠ"}
    P -->|Normal| C["Concierge<br/>ä¸å¯§ãƒ»å®‰å¿ƒ"]
    P -->|Emergency| T["Tactical<br/>å‘½ä»¤å½¢ãƒ»çŸ­æ½”"]
    
    C --> G3["Vertex AI Gemini"]
    T --> G3
    G3 --> N["ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ"]
```

## 3. éåŒæœŸå®‰å…¨æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Async Visual Analysis)

```mermaid
sequenceDiagram
    participant App as Flutter App
    participant CR as Cloud Run
    participant SV as Street View API
    participant G3 as Vertex AI Vision

    App->>CR: POST /analyzeRouteSafety (points[])
    loop å„åœ°ç‚¹ã‚’é †æ¬¡å‡¦ç†
        CR->>SV: ç”»åƒå–å¾— (lat, lng)
        SV-->>CR: Street View ç”»åƒ
        CR->>G3: å®‰å…¨æ€§è§£æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        G3-->>CR: Score + Comment
        CR-->>App: SSE: {id, score, comment}
    end
    App->>App: åœ°å›³ä¸Šã«ãƒ”ãƒ³è¡¨ç¤º
```

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

| API | å¤±æ•—æ™‚ã®æŒ™å‹• |
| :--- | :--- |
| **OpenWeatherMap** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’ã€Œä¸­ã€ã§ç¶™ç¶šã€‚ |
| **Google Routes API** | äº‹å‰ã«å®šç¾©ã—ãŸãƒ¢ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆï¼ˆæ¸‹è°·ã‚¨ãƒªã‚¢ç”¨ï¼‰ã‚’è¿”å´ã€‚ |
| **Street View Static API** | è©²å½“åœ°ç‚¹ã®ã‚¹ã‚³ã‚¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ¬¡ã®åœ°ç‚¹ã¸é€²ã‚€ã€‚ |
| **Vertex AI (Gemini)** | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯å›ºå®šã®æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã€‚ |
