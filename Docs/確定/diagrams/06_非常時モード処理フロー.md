# 非常時モード処理フロー

**コンセプト**: 複数のリスク（浸水・事故・土砂・強風）を総合評価し、生存最優先ルートを提示

```mermaid
flowchart TD
    A["リクエスト受信"] --> B["コンテキスト取得"]
    
    subgraph RiskCheck["リスクチェック（並列）"]
        B --> R1["🌧️ 浸水リスク<br/>ハザードマップ照合"]
        B --> R2["🚗 事故リスク<br/>Mock事故データ"]
        B --> R3["🌊 土砂災害リスク<br/>ハザードマップ"]
        B --> R4["💨 強風リスク<br/>OpenWeatherMap"]
    end
    
    R1 --> C["リスク統合評価"]
    R2 --> C
    R3 --> C
    R4 --> C
    
    C --> D{"総合リスク<br/>レベル"}
    
    D -->|"LOW"| E["通常ルート検索"]
    D -->|"MEDIUM"| F["危険エリア回避ルート"]
    D -->|"HIGH"| G["全リスク回避ルート"]
    
    E --> H["ルート候補取得"]
    F --> H
    G --> H
    
    H --> I{"安全ルート<br/>あり?"}
    I -->|"Yes"| J["最安全ルート選択"]
    I -->|"No"| K["🔄 自律リトライ"]
    
    K --> L["安全地点をWaypoint設定"]
    L --> H
    
    J --> M["緊急ナレーション生成"]
    M --> N["レスポンス返却"]
```

## 評価対象リスク
| リスク | データソース | 重み付け |
| :--- | :--- | :--- |
| 浸水 | ハザードマップ | 高 |
| 事故 | Mockデータ | 中 |
| 土砂災害 | ハザードマップ | 高 |
| 強風 | OpenWeatherMap | 低〜中 |
